name: Code Review and Notification

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  review:
    runs-on: ubuntu-latest
    name: Code Quality Review

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Check for analyze_and_notify.py
        run: |
          if [ ! -f analyze_and_notify.py ]; then
            echo "Erreur : analyze_and_notify.py n'existe pas dans le dépôt."
            exit 1
          fi

      - name: Run Code Review and Notification
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        run: |
          # Vérifier que les secrets sont définis
          if [ -z "$GEMINI_API_KEY" ] || [ -z "$GMAIL_APP_PASSWORD" ] || [ -z "$SENDER_EMAIL" ]; then
            echo "Erreur : Une ou plusieurs variables secrètes ne sont pas définies."
            exit 1
          fi

          # Récupérer l'email de l'auteur du commit
          COMMIT_AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          echo "Auteur du commit : $COMMIT_AUTHOR_EMAIL"

          # Récupérer les fichiers modifiés
          CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)
          echo "Fichiers modifiés : $CHANGED_FILES"

          # Exécuter le script d'analyse
          python analyze_and_notify.py "$COMMIT_AUTHOR_EMAIL" "$CHANGED_FILES"
